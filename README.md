# 画像結合スクリプト (Image Combination Script)

## 概要

このリポジトリには、少しずつ位置をずらして撮影した複数の画像を、自動で位置合わせして1枚の画像に結合するためのPythonスクリプト `process_images.py` が含まれています。

主に、三脚を使わずに手持ちで撮影した写真など、微妙なズレがある一連の画像を処理し、パノラマ風の画像を生成することを目的としています。

## 主な機能

-   **テンプレートマッチングによる自動位置合わせ**: 最初の画像から特徴的な領域（テンプレート）を自動で抽出し、他の画像内でその位置を特定することで、全画像の位置を揃えます。
-   **中央トリミング**: 位置合わせ後、すべての画像をあらかじめ定義された解像度で中央から切り抜きます。
-   **3枚画像の結合**: 3枚の画像をそれぞれ左・中央・右のパーツとして扱い、自然に見えるように連結して1枚の画像を生成します。
-   **自動保存**: 最終的な成果物は、スクリプト実行日の日付をファイル名 (`YYYY-MM-DD.jpg`) として自動的に保存されます。

## 前提条件

このスクリプトを実行するには、以下の環境が必要です。

-   Python 3.x
-   ライブラリ:
    -   OpenCV (`opencv-python`)
    -   NumPy (`numpy`)

以下のコマンドで必要なライブラリをインストールできます。

```bash
pip install opencv-python numpy
```

## 使い方

1.  **画像の準備**
    -   処理したい3枚の画像ファイルを、`process_images.py` と同じディレクトリに配置します。
    -   ファイル名は `IMG_` で始まるJPG形式（例: `IMG_0412.JPG`, `IMG_0414.JPG`, `IMG_0416.JPG`）である必要があります。

2.  **スクリプトの実行**
    -   ターミナルを開き、以下のコマンドを実行します。

    ```bash
    python3 process_images.py
    ```

3.  **結果の確認**
    -   実行が完了すると、同じディレクトリに以下のファイルが生成されます。
        -   `aligned_IMG_****.JPG`: 位置合わせとトリミングが行われた中間ファイル（3枚）
        -   `YYYY-MM-DD.jpg`: 最終的に結合された画像ファイル（例: `2025-07-04.jpg`）

## 処理の流れ

このスクリプトは、内部的に2つの主要な処理を連続して行います。

1.  **位置合わせとトリミング (`align_and_crop`)**
    1.  `IMG_*.JPG` ファイルをすべて読み込みます。
    2.  最初の画像の中央付近から、1000x1000ピクセルの領域を「テンプレート」として切り出します。
    3.  すべての画像に対してテンプレートマッチングを行い、テンプレートがどの位置にあるかを検出します。
    4.  検出された位置のズレの中央値を計算し、すべての画像がその目標座標に揃うように各画像を平行移動させます。
    5.  位置を揃えたすべての画像を、スクリプト冒頭で定義された `OUTPUT_WIDTH` と `OUTPUT_HEIGHT` のサイズで中央からトリミングし、`aligned_` という接頭辞をつけて保存します。

2.  **画像の結合 (`combine_images`)**
    1.  生成された3枚の `aligned_*.JPG` ファイルを読み込みます。
    2.  1枚目の画像の右側1/3、2枚目の中央1/3、3枚目の左側1/3をそれぞれ切り出します。
    3.  `[3枚目の左側] + [2枚目の中央] + [1枚目の右側]` の順で水平に結合します。
    4.  結合した画像を `YYYY-MM-DD.jpg` という名前で保存します。

## 設定

スクリプトの冒頭で、以下の項目を調整できます。

-   `OUTPUT_WIDTH`: 最終的な画像の幅（ピクセル単位）。
-   `OUTPUT_HEIGHT`: 最終的な画像の高さ（ピクセル単位）。

```python
# --- 設定 ---
# align_and_crop.py の設定
OUTPUT_WIDTH = 5700
OUTPUT_HEIGHT = 3900
```

## 注意点

-   画像の重なりが少ない場合や、雲や壁などの特徴のない領域がテンプレートに選ばれた場合、位置合わせがうまくいかないことがあります。
-   現状では、処理対象の画像は3枚であることを前提としています。
