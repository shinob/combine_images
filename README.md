# 画像結合スクリプト (Image Combination Script)

## 概要

このリポジトリには、少しずつ位置をずらして撮影した複数の画像を、自動で位置合わせして1枚の画像に結合するためのPythonスクリプト `process_images.py` が含まれています。

主に、三脚を使わずに手持ちで撮影した写真など、微妙なズレがある一連の画像を処理し、パノラマ風の画像を生成することを目的としています。

## 主な機能

-   **動的なテンプレート抽出による自動位置合わせ**: 最初の入力画像から特徴的な領域（テンプレート）を自動で抽出し、他の画像内でその位置を特定することで、全画像の位置を揃えます。
-   **インメモリ処理**: 位置合わせとトリミングはメモリ上で行われるため、中間ファイルがディスクに保存されません。
-   **中央トリミング**: 位置合わせ後、すべての画像をあらかじめ定義された解像度で中央から切り抜きます。
-   **複数画像の動的結合**: `IMG_*.JPG` ファイルの枚数に応じて、画像をN個のセグメントに分割し、それらを連結して1枚の画像を生成します。
-   **自動保存**: 最終的な成果物は、スクリプト実行日の日付をファイル名 (`YYYY-MM-DD.jpg`) として自動的に保存されます。

## 前提条件

このスクリプトを実行するには、以下の環境が必要です。

-   Python 3.x
-   ライブラリ:
    -   OpenCV (`opencv-python`)
    -   NumPy (`numpy`)

以下のコマンドで必要なライブラリをインストールできます。

```bash
pip install opencv-python numpy
```

## 使い方

1.  **画像の準備**
    -   処理したい画像ファイル（2枚以上）を、`process_images.py` と同じディレクトリに配置します。
    -   ファイル名は `IMG_` で始まるJPG形式（例: `IMG_0412.JPG`, `IMG_0414.JPG`, `IMG_0416.JPG`）である必要があります。

2.  **スクリプトの実行**
    -   ターミナルを開き、以下のコマンドを実行します。

    ```bash
    python3 process_images.py
    ```

3.  **結果の確認**
    -   実行が完了すると、同じディレクトリに以下のファイルが生成されます。
        -   `YYYY-MM-DD.jpg`: 最終的に結合された画像ファイル（例: `2025-07-09.jpg`）

## 処理の流れ

このスクリプトは、内部的に以下の処理を連続して行います。

1.  **テンプレートの生成と位置合わせ**
    1.  `IMG_*.JPG` ファイルをすべて読み込みます。
    2.  最初の画像 (`IMG_*.JPG` の中でファイル名が最も若いもの) の中央付近から、指定された座標とサイズで領域を「テンプレート」として切り出します。
    3.  すべての画像に対してテンプレートマッチングを行い、テンプレートがどの位置にあるかを検出します。
    4.  検出された位置のズレの中央値を計算し、すべての画像がその目標座標に揃うように各画像を平行移動させます。
    5.  位置を揃えたすべての画像を、スクリプト冒頭で定義された `OUTPUT_WIDTH` と `OUTPUT_HEIGHT` のサイズで中央からトリミングします。この際、中間ファイルはディスクに保存されず、メモリ上で次の処理に渡されます。

2.  **画像の結合**
    1.  メモリ上に保持されている調整済みの画像（N枚）を読み込みます。
    2.  画像の枚数（N）に応じて、各画像の幅をN分割したセグメントを作成します。
    3.  N枚目の画像から最初のセグメント、N-1枚目の画像から2番目のセグメント、...、1枚目の画像から最後のセグメントを切り出します。
    4.  切り出した各セグメントを順番に水平に結合します。
    5.  結合した画像を `YYYY-MM-DD.jpg` という名前で保存します。

## 設定

スクリプトの設定は `config.py` ファイルで行います。以下の項目を調整できます。

-   `OUTPUT_WIDTH`: 最終的な画像の幅（ピクセル単位）。
-   `OUTPUT_HEIGHT`: 最終的な画像の高さ（ピクセル単位）。
-   `TEMPLATE_CROP_X`, `TEMPLATE_CROP_Y`, `TEMPLATE_CROP_W`, `TEMPLATE_CROP_H`: テンプレートを切り出す際の座標とサイズ。

```python
# config.py

# 最終的な出力画像のサイズ
OUTPUT_WIDTH = 5700
OUTPUT_HEIGHT = 3900

# テンプレート切り出しの座標とサイズ (process_images.py で使用)
TEMPLATE_CROP_X = 1600
TEMPLATE_CROP_Y = 1500
TEMPLATE_CROP_W = 1000
TEMPLATE_CROP_H = 1000
```

## その他のスクリプト

-   `del.sh`: `IMG_*.JPG` ファイルを削除するためのシェルスクリプトです。

## 注意点

-   画像の重なりが少ない場合や、雲や壁などの特徴のない領域がテンプレートに選ばれた場合、位置合わせがうまくいかないことがあります。
-   結合処理には、最低2枚の画像が必要です。
